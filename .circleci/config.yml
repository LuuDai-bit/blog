# This config was automatically generated from your source code
# Stacks detected: deps:node:.,deps:ruby:.,package_manager:yarn:
version: 2.1
orbs:
  ruby: circleci/ruby@2.0.1
  codecov: codecov/codecov@3
jobs:
  test-ruby:
    # Install gems, run rails tests
    docker:
      - image: cimg/ruby:3.3.7-node
        environment:
          - RAILS_ENV=test
      - image: circleci/postgres:9.5-alpine
      - image: redis:7

    steps:
      - checkout
      - ruby/install-deps
      - run:
          name: Wait for Redis
          command: dockerize -wait tcp://localhost:6379 -timeout 1m
      - run:
          name: Wait for db
          command: dockerize -wait tcp://localhost:5432 -timeout 1m
      - run:
          name: prepare db
          command: bundle exec rails db:prepare
      - run:
          name: rails test
          command: bundle exec rspec
      - codecov/upload:
          file: coverage/lcov.info
      - run:
          name: Calculate Coverage
          command: |
            PROJECT_COVERAGE=$(awk -F: '/LF:/ { lf += $2 } /LH:/ { lh += $2 } END { print int((lh/lf)*100) }' coverage/lcov.info)

            PATCH_COVERAGE=$PROJECT_COVERAGE

            echo "Project coverage: $PROJECT_COVERAGE"
            echo "Patch coverage: $PATCH_COVERAGE"

            echo "CIRCLE_PR_NUMBER: $CIRCLE_PR_NUMBER"

            JSON=$(jq -n \
              --arg owner "$CIRCLE_PROJECT_USERNAME" \
              --arg repo "$CIRCLE_PROJECT_REPONAME" \
              --argjson pr "$CIRCLE_PR_NUMBER:-0" \
              --argjson project "$PROJECT_COVERAGE" \
              --argjson patch "$PATCH_COVERAGE" \
              '{project_coverage:$project, patch_coverage:$patch, pull_request_number:$pr, owner:$owner, repo:$repo}')

            echo "Generated JSON: $JSON"

            curl --location 'https://codedehoc.click/gateway/comments' \
              --header "token: $CDH_API_TOKEN" \
              --header 'Content-Type: application/json' \
              --data "$JSON"

workflows:
  build-and-test:
    jobs:
      - test-ruby
